---
description: Scan for vulnerabilities in dependencies, containers, and infrastructure
activates: vulnerability-scanner
argument-hint: --target=dependencies|container|infrastructure --scanner=trivy|snyk|native [--output=json|markdown|sarif]
---

# Vulnerability Scanning Tool - Post-Development Security Audit

Run comprehensive vulnerability scans on your codebase, dependencies, and containers using industry-standard tools.

## Command Syntax

```bash
/ccu:tools:security:vulnerability-scanning --target=dependencies|container|infrastructure [options]
```

## Parameters

### Required Parameters
- `--target=dependencies|container|infrastructure` - What to scan
  - `dependencies` - npm, pip, gem, go modules, etc.
  - `container` - Docker images and Dockerfiles
  - `infrastructure` - IaC files (Terraform, K8s manifests)

### Optional Parameters
- `--scanner=trivy|snyk|native` - Scanner to use (default: trivy)
- `--severity=critical|high|medium|low` - Minimum severity to report (default: low)
- `--output=json|markdown|sarif` - Output format (default: markdown)
- `--fix=true` - Attempt auto-remediation where possible
- `--ignore-file=.trivyignore` - Path to ignore file
- `--fail-on=critical|high` - Exit with error if severity found

## MCP Integration

### Trivy MCP (Primary Scanner)
- **Repository**: https://github.com/aquasecurity/trivy-mcp
- **Purpose**: Container and dependency vulnerability scanning
- **Usage**: Automated scanning with comprehensive vulnerability database

### Mem0 MCP
- **Purpose**: Store vulnerability patterns and successful remediations
- **Storage Key**: `vulnerability_scan_[target]_[timestamp]`

## Execution Flow

### Step 1: Detect Project Type

```bash
ğŸ“ Analyzing project structure...

Detected:
âœ“ Node.js (package.json found)
âœ“ Docker (Dockerfile found)
âœ“ Terraform (*.tf files found)
```

### Step 2: Run Appropriate Scanners

#### For Dependencies:

```bash
ğŸ” SCANNING DEPENDENCIES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Initializing:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Scanning npm:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Scanning Docker: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  60% ğŸ”„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**Native scanners by language:**
- Node.js: `npm audit` / `yarn audit`
- Python: `pip-audit` / `safety check`
- Ruby: `bundle-audit`
- Go: `nancy` / `gosec`
- Java: `dependency-check`

**Trivy for comprehensive scanning:**
```bash
trivy fs . --severity HIGH,CRITICAL --format json
```

#### For Containers:

```bash
ğŸ³ SCANNING CONTAINER IMAGES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Image layers:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
OS packages:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
App libraries:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**Docker image scanning:**
```bash
# Scan local image
trivy image myapp:latest

# Scan Dockerfile
trivy config Dockerfile

# Generate SBOM
trivy image --format cyclonedx myapp:latest > sbom.json
```

#### For Infrastructure:

```bash
ğŸ—ï¸ SCANNING INFRASTRUCTURE AS CODE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Terraform:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Kubernetes:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
CloudFormation:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**IaC scanning:**
```bash
# Terraform
trivy config terraform/

# Kubernetes
trivy config k8s/

# Dockerfile
trivy config Dockerfile
```

### Step 3: Generate Report

```
ğŸ“Š VULNERABILITY SCAN RESULTS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

SUMMARY:
ğŸ”´ Critical: 1
ğŸŸ  High: 3
ğŸŸ¡ Medium: 7
ğŸ”µ Low: 15
âšª Info: 23

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”´ CRITICAL VULNERABILITIES (1)

1. Remote Code Execution in log4j
   Package: log4j-core@2.14.0
   Fixed in: 2.17.0
   CVE: CVE-2021-44228
   CVSS: 10.0

   Remediation:
   npm update log4j-core@2.17.0

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸŸ  HIGH VULNERABILITIES (3)

1. SQL Injection in sequelize
   Package: sequelize@5.21.0
   Fixed in: 6.0.0
   CVE: CVE-2021-3702
   CVSS: 8.8

2. XSS in express-handlebars
   Package: express-handlebars@3.0.0
   Fixed in: 5.3.0
   CVE: CVE-2021-32819
   CVSS: 7.5

3. Path Traversal in tar
   Package: tar@4.4.13
   Fixed in: 6.1.0
   CVE: CVE-2021-32803
   CVSS: 7.5

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ RECOMMENDATIONS:

1. Update critical vulnerabilities immediately:
   npm update log4j-core@2.17.0

2. Review and update high severity issues:
   npm update sequelize@6.0.0 express-handlebars@5.3.0 tar@6.1.0

3. Consider using npm audit fix:
   npm audit fix --force

4. Add to CI/CD pipeline:
   Add 'trivy fs .' to your build process

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Step 4: Generate Output Files

**vulnerability-report.json:**
```json
{
  "scan_timestamp": "2024-01-20T10:30:00Z",
  "scanner": "trivy",
  "summary": {
    "critical": 1,
    "high": 3,
    "medium": 7,
    "low": 15
  },
  "vulnerabilities": [...]
}
```

**vulnerability-report.md:**
Markdown formatted report for human reading

**sbom.json:**
Software Bill of Materials in CycloneDX or SPDX format

### Step 5: Store Patterns with Mem0

```
ğŸ’¾ Storing vulnerability patterns for future reference...

Saved: vulnerability_scan_dependencies_2024_01_20
Pattern: log4j RCE vulnerability in Java applications
Remediation: Upgrade to 2.17.0 or later
```

## Integration with CI/CD

Add to your pipeline:

```yaml
# GitHub Actions
- name: Run Trivy vulnerability scanner
  uses: aquasecurity/trivy-action@master
  with:
    scan-type: 'fs'
    scan-ref: '.'
    format: 'sarif'
    output: 'trivy-results.sarif'

# GitLab CI
vulnerability_scan:
  script:
    - trivy fs . --exit-code 1 --severity HIGH,CRITICAL
```

## Best Practices

1. **Regular Scanning**: Run daily in CI/CD
2. **Fail Fast**: Block deployments on critical vulnerabilities
3. **Ignore False Positives**: Use .trivyignore file
4. **Track Remediation**: Store successful fixes in Mem0
5. **Update Databases**: Keep vulnerability databases current

## Common Use Cases

### Quick dependency check:
```bash
/ccu:tools:security:vulnerability-scanning --target=dependencies
```

### Pre-deployment container scan:
```bash
/ccu:tools:security:vulnerability-scanning --target=container --fail-on=high
```

### Comprehensive security audit:
```bash
/ccu:tools:security:vulnerability-scanning --target=dependencies,container,infrastructure --output=json
```

## Notes

- Scanning is performed POST-development, not during planning
- Results don't block development but inform deployment decisions
- Auto-remediation only available for some dependency updates
- Container base image recommendations provided when available